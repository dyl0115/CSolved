<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head th:insert="common/head.html">
        <title>CS Interview Platform</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    </head>
    <body class="bg-gray-50">
        <th:block th:replace="~{common/navigation :: default-navigation}"/>
        
        <main class="max-w-5xl mx-auto mt-8 px-4 pb-12">
            <!-- 질문글 상세 섹션 -->
            <section class="question-detail mb-8" th:object="${question}">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <!-- 헤더 영역 -->
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-start justify-between gap-4">
                            <div class="flex-1">
                                <h1 class="text-2xl font-bold text-gray-900 mb-3" th:text="*{title}">질문글 제목</h1>
                                <div class="flex flex-wrap gap-2 mb-4">
                                <span th:each="tag : *{tags}"
                                      class="px-3 py-1 bg-blue-50 text-blue-700 rounded-full text-sm font-medium hover:bg-blue-100 transition-colors"
                                      th:text="${tag.name}">
                                </span>
                                </div>
                                <div class="flex items-center gap-4 text-sm text-gray-600">
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="book-text" class="w-4 h-4"></i>
                                        <span th:text="*{categoryName}">카테고리</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="user" class="w-4 h-4"></i>
                                        <span th:text="*{anonymous} ? '익명' : *{authorNickname}">작성자</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="eye" class="w-4 h-4"></i>
                                        <span th:text="*{views}">조회수</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <i data-lucide="clock" class="w-4 h-4"></i>
                                        <span class="timeago" th:data-date="*{createdAt}"
                                              th:text="${#temporals.format(question.createdAt, 'yyyy/MM/dd hh:mm')}">
                                    </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 수정/삭제 버튼 -->
                            <div class="flex gap-2" th:if="${user.id == question.authorId}">
                                <a th:href="@{/questions/{id}/edit-form(id=*{questionId})}"
                                   class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                                    <i data-lucide="edit" class="w-4 h-4"></i>
                                    수정
                                </a>
                                <button th:onclick="'deleteQuestion(' + *{questionId} + ')'"
                                        class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 본문 영역 -->
                    <div class="p-6 bg-white">
                        <div class="prose max-w-none" th:utext="*{content}">질문글 내용</div>
                    </div>
                    
                    <!-- 하단 액션 영역 -->
                    <div class="px-6 py-4 bg-gray-50 border-t border-gray-100">
                        <div class="flex items-center gap-4">
                            <button th:onclick="|increaseLikes(*{questionId})|"
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-white text-gray-700 rounded-lg border border-gray-200 hover:bg-gray-50 transition-colors">
                                <i data-lucide="thumbs-up" class="w-5 h-5"></i>
                                <span th:text="*{likes}" class="font-medium"></span>
                            </button>
                            <button onclick="toggleAnswerForm()"
                                    class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                <i data-lucide="message-square" class="w-5 h-5"></i>
                                답변하기
                            </button>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- 답변 작성 폼 -->
            <section id="answer-form" class="answer-create-form hidden mb-8" th:object="${question}">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h2 class="text-lg font-bold text-gray-900 mb-4">답변 작성하기</h2>
                    <form th:action="@{/questions/{id}/answers(id=*{questionId})}" method="POST">
                    <textarea name="content"
                              class="w-full p-4 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                              rows="6"
                              placeholder="답변을 입력하세요..."></textarea>
                        
                        <div class="flex items-center justify-between mt-4">
                            <div class="flex items-center gap-2">
                                <input type="checkbox"
                                       id="answer-anonymous"
                                       th:field="${answerCreateForm.anonymous}"
                                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="answer-anonymous" class="text-sm text-gray-600">
                                    익명으로 작성하기
                                </label>
                            </div>
                            <button type="submit"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                답변 등록
                            </button>
                        </div>
                    </form>
                </div>
            </section>
            
            <!-- 답변 목록 -->
            <section class="space-y-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4" th:text="|답변 ${answers.size()}개|">답변 0개</h2>
                
                <div th:each="answer : ${answers}" th:object="${answer}"
                     class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <!-- 답변 헤더 -->
                    <div class="p-6 flex items-start justify-between border-b border-gray-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                                <i data-lucide="user" class="w-6 h-6 text-gray-500"></i>
                            </div>
                            <div>
                                <div class="font-medium text-gray-900"
                                     th:text="*{anonymous} ? '익명' : *{authorNickname}">답변자
                                </div>
                                <div class="text-sm text-gray-500">
                                <span class="timeago" th:data-date="*{createdAt}"
                                      th:text="${#temporals.format(answer.createdAt, 'yyyy/MM/dd hh:mm')}">
                                </span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 평점 & 삭제 버튼 -->
                        <div class="flex items-center gap-4">
                            <div class="flex items-center" th:attr="data-answer-id=*{answerId}">
                                <div class="flex gap-1">
                                    <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                        <button type="button"
                                                th:onclick="|rateAnswer(*{answerId}, ${i})|"
                                                class="focus:outline-none transition-transform hover:scale-110"
                                                th:attr="data-rating=${i}">
                                            <i data-lucide="star"
                                               th:class="|w-5 h-5 ${i <= answer.averageScore ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'} transition-colors|">
                                            </i>
                                        </button>
                                    </th:block>
                                </div>
                                <span class="ml-2 text-sm text-gray-600"
                                      th:text="|*{averageScore} (*{voterCount}명)|"></span>
                            </div>
                            
                            <div th:if="${user.id == answer.userId}">
                                <button th:onclick="'deleteAnswer(' + *{answerId} + ')'"
                                        class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 답변 내용 -->
                    <div class="p-6">
                        <div class="prose max-w-none" th:text="*{content}">답변 내용</div>
                    </div>
                    
                    <!-- 댓글 섹션 -->
                    <div class="border-t border-gray-100">
                        <div class="p-6">
                            <div class="space-y-4">
                                <!-- 댓글 목록 -->
                                <div th:each="comment : ${answer.comments}" th:object="${comment}"
                                     class="flex items-start gap-3 pb-4">
                                    <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center gap-2">
                                            <span class="font-medium text-gray-900"
                                                  th:text="*{anonymous} ? '익명' : *{authorNickname}">댓글작성자</span>
                                                <span class="text-sm text-gray-500 timeago"
                                                      th:data-date="*{createdAt}"
                                                      th:text="${#temporals.format(comment.createdAt, 'yyyy/MM/dd hh:mm')}">
                                            </span>
                                            </div>
                                            <button th:if="${user.id == comment.authorId}"
                                                    th:onclick="'deleteComment(' + *{commentId} + ')'"
                                                    class="text-gray-400 hover:text-red-600">
                                                <i data-lucide="x" class="w-4 h-4"></i>
                                            </button>
                                        </div>
                                        <p class="text-gray-700 mt-1" th:text="*{content}">댓글 내용</p>
                                    </div>
                                </div>
                                
                                <!-- 댓글 작성 폼 -->
                                <div class="mt-4">
                                    <button onclick="toggleCommentForm(this)"
                                            th:attr="data-answer-id=*{answerId}"
                                            class="text-blue-600 hover:text-blue-700 text-sm font-medium focus:outline-none">
                                        댓글 달기
                                    </button>
                                    
                                    <div th:id="'commentForm-' + *{answerId}" class="hidden mt-3">
                                        <form th:action="@{/questions/{questionId}/answers/{answerId}/comment(questionId=${question.questionId},answerId=*{answerId})}"
                                              method="POST"
                                              class="flex flex-col gap-3">
                                        <textarea name="content"
                                                  class="w-full p-3 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                  rows="2"
                                                  placeholder="댓글을 입력하세요..."></textarea>
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-2">
                                                    <input type="checkbox"
                                                           th:id="'anonymous-' + *{answerId}"
                                                           th:field="${commentCreateForm.anonymous}"
                                                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                    <label th:for="'anonymous-' + *{answerId}"
                                                           class="text-sm text-gray-600">
                                                        익명으로 작성하기
                                                    </label>
                                                </div>
                                                <button type="submit"
                                                        class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                                                    댓글 등록
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <script>
            // Lucide 아이콘 초기화
            lucide.createIcons();

            // 별점 평가 함수
            async function rateAnswer(answerId, rating) {
                try {
                    const response = await fetch(`/api/answers/${answerId}/rate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(rating)
                    });

                    if (response.status === 409) {
                        alert('이미 평가한 답변입니다. 답변당 한 번만 평가할 수 있습니다.');
                        return;
                    }

                    if (!response.ok) {
                        throw new Error('평가 제출에 실패했습니다.');
                    }

                    const result = await response.json();
                    updateStarRating(answerId, rating);

                    const ratingContainer = document.querySelector(`[data-answer-id="${answerId}"]`)
                        .querySelector('span');
                    ratingContainer.textContent = `${result.averageScore.toFixed(1)} (${result.voterCount}명)`;

                } catch (error) {
                    console.error('Error:', error);
                    alert('평가 제출 중 오류가 발생했습니다.');
                }
            }

            // 별점 UI 업데이트 함수
            function updateStarRating(answerId, selectedRating) {
                const stars = document.querySelector(`[data-answer-id="${answerId}"]`)
                    .querySelectorAll('i[data-lucide="star"]');

                stars.forEach((star, index) => {
                    if (index < selectedRating) {
                        star.classList.remove('text-gray-300');
                        star.classList.add('text-yellow-400', 'fill-yellow-400');
                    } else {
                        star.classList.remove('text-yellow-400', 'fill-yellow-400');
                        star.classList.add('text-gray-300');
                    }
                });
            }

            // 댓글 폼 토글 함수
            function toggleCommentForm(button) {
                const answerId = button.getAttribute('data-answer-id');
                const formId = `commentForm-${answerId}`;
                const form = document.getElementById(formId);

                // 다른 모든 폼 닫기
                document.querySelectorAll('[id^="commentForm-"]').forEach(otherForm => {
                    if (otherForm.id !== formId) {
                        otherForm.classList.add('hidden');
                    }
                });

                // 현재 폼 토글
                form.classList.toggle('hidden');
            }

            // 답변 폼 토글 함수
            function toggleAnswerForm() {
                const form = document.getElementById('answer-form');
                form.classList.toggle('hidden');

                // 폼이 보이게 될 때 스크롤
                if (!form.classList.contains('hidden')) {
                    form.scrollIntoView({behavior: 'smooth'});
                }
            }

            // 질문글 좋아요 함수
            async function increaseLikes(questionId) {
                try {
                    const response = await fetch(`/api/questions/${questionId}/likes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    switch (response.status) {
                        case 200:
                            window.location.reload();
                            break;
                        case 409:
                            alert('게시글당 한번만 좋아요를 누를 수 있습니다.');
                            break;
                        default:
                            alert('작업 중 오류가 발생했습니다.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('서버와의 통신 중 오류가 발생했습니다.');
                }
            }

            // 삭제 관련 함수들
            async function deleteQuestion(questionId) {
                if (confirm('정말 삭제하시겠습니까?')) {
                    try {
                        const response = await fetch(`/api/questions/${questionId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        if (!response.ok) {
                            throw new Error('삭제에 실패했습니다.');
                        }

                        window.location.replace("/questions");

                    } catch (error) {
                        console.error('Error:', error);
                        alert('삭제 중 오류가 발생했습니다.');
                    }
                }
            }

            async function deleteAnswer(answerId) {
                if (confirm('정말 삭제하시겠습니까?')) {
                    try {
                        const response = await fetch(`/api/answers/${answerId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        if (!response.ok) {
                            throw new Error('삭제에 실패했습니다.');
                        }

                        window.location.reload();
                    } catch (error) {
                        console.error('Error:', error);
                        alert('삭제 중 오류가 발생했습니다.');
                    }
                }
            }

            async function deleteComment(commentId) {
                if (confirm('정말 삭제하시겠습니까?')) {
                    try {
                        const response = await fetch(`/api/comments/${commentId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        if (!response.ok) {
                            throw new Error('삭제에 실패했습니다.');
                        }

                        window.location.reload();
                    } catch (error) {
                        console.error('Error:', error);
                        alert('삭제 중 오류가 발생했습니다.');
                    }
                }
            }
        </script>
    </body>
</html>