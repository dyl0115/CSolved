<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head th:insert="common/head.html">
        <title>CS Interview Platform</title>
    </head>
    <body class="bg-gray-100">
        <th:block th:replace="~{common/navigation :: default-navigation}"/>
        
        <main class="max-w-7xl mx-auto mt-6 px-4">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    
                    <!--질문글 상세 섹션-->
                    <section class="question-detail" th:object="${question}">
                        <div class="mb-4">
                            <h1 class="text-2xl font-bold mb-2" th:text="*{title}">질문글 제목</h1>
                            <div class="flex items-center text-gray-600 text-sm">
                                <span th:text="${#temporals.format(question.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
                                <span class="mx-2">•</span>
                                <span th:text="'작성자: ' + *{authorNickname}">작성자</span>
                                <span class="mx-2">•</span>
                                <span th:text="'조회수: ' + *{views}">조회수</span>
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mb-4">
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm hover:bg-blue-200 transition-colors"
                                  th:each="tag : *{tags}"
                                  th:text="${tag.name}">
                            </span>
                        </div>
                        
                        <div class="bg-white rounded-lg p-6 mb-1 shadow-sm border border-gray-200">
                            <div class="prose max-w-none" th:utext="*{content}">질문글 내용</div>
                        </div>
                        
                        <div class="flex justify-between items-center mb-6">
                            <div class="flex gap-2">
                                <button class="flex items-center gap-1 text-gray-600 hover:text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                         fill="currentColor">
                                        <path d="M2 10.5a1.5 1.5 0 113 0v6a1.5 1.5 0 01-3 0v-6zM6 10.333v5.43a2 2 0 001.106 1.79l.05.025A4 4 0 008.943 18h5.416a2 2 0 001.962-1.608l1.2-6A2 2 0 0015.56 8H12V4a2 2 0 00-2-2 1 1 0 00-1 1v.667a4 4 0 01-.8 2.4L6.8 7.933a4 4 0 00-.8 2.4z"/>
                                    </svg>
                                    <span th:text="*{likes}">추천수</span>
                                </button>
                                <button onclick="toggleAnswerForm()"
                                        class="flex items-center gap-1 text-gray-600 hover:text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                         fill="currentColor">
                                        <path fill-rule="evenodd"
                                              d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z"
                                              clip-rule="evenodd"/>
                                    </svg>
                                    <span th:text="*{answerCount}">답변수</span>
                                </button>
                            </div>
                            <!-- 수정/삭제 버튼 스타일 통일 -->
                            <div class="flex gap-2" th:if="${user.id == question.authorId}">
                                <a th:href="@{/questions/{id}/edit(id=*{questionId})}"
                                   class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                                    수정
                                </a>
                                <a th:href="@{/questions/{id}/delete(id=*{questionId})}"
                                   class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                                    삭제
                                </a>
                            </div>
                        </div>
                    </section>
                    
                    <!--답글 폼 섹션-->
                    <section id="answer-form" class="answer-create-form hidden" th:object="${question}">
                        <div class="border rounded-lg p-6 mb-6">
                            <h2 class="text-lg font-bold mb-4">답변 작성하기</h2>
                            <form th:action="@{/questions/{id}/answers(id=*{questionId})}" method="POST">
                                <textarea name="content"
                                          class="w-full p-4 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                          rows="4"
                                          placeholder="답변을 입력하세요..."></textarea>
                                
                                <div class="flex items-center justify-between mt-3">
                                    <div class="flex items-center space-x-2">
                                        <input type="checkbox"
                                               id="answer-anonymous"
                                               th:field="${answerCreateForm.anonymous}"
                                               class="rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                        <label for="answer-anonymous" class="text-sm text-gray-600">
                                            익명으로 작성하기
                                        </label>
                                    </div>
                                    <button type="submit"
                                            class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none">
                                        답변 등록
                                    </button>
                                </div>
                            </form>
                        </div>
                    </section>
                    
                    <!--답글 리스트-->
                    <section class="answer-list">
                        <div class="border rounded-lg p-6 mb-6 relative" th:each="answer : ${answers}"
                             th:object="${answer}">
                            
                            <div class="absolute top-4 right-4">
                                <div class="flex items-center">
                                    <div class="flex space-x-1" th:attr="data-answer-id=*{answerId}">
                                        <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                            <button
                                                    type="button"
                                                    th:onclick="|rateAnswer(*{answerId}, ${i})|"
                                                    class="focus:outline-none transition-colors duration-200 hover:scale-110"
                                                    th:attr="data-rating=${i}">
                                                <svg th:class="|w-5 h-5 ${i <= answer.averageScore ? 'text-yellow-400' : 'text-gray-200'} transition-colors duration-200|"
                                                     xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"
                                                     fill="currentColor">
                                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                                </svg>
                                            </button>
                                        </th:block>
                                    </div>
                                    <span class="ml-2 text-sm text-gray-600"
                                          th:text="|*{averageScore} (*{voterCount}명)|"></span>
                                    
                                    <!-- 답글 수정/삭제 버튼 스타일 통일 -->
                                    <div class="flex gap-2 ml-4" th:if="${user.id == answer.userId}">
                                        <a th:href="@{/answers/{id}/edit(id=*{answerId})}"
                                           class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                                            수정
                                        </a>
                                        <a th:href="@{/answers/{id}/delete(id=*{answerId})}"
                                           class="px-3 py-1.5 text-sm bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                                            삭제
                                        </a>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center mb-4">
                                <div class="w-8 h-8 rounded-full bg-gray-500"></div>
                                <div class="ml-3">
                                    <span class="font-bold"
                                          th:text="*{anonymous} ? '익명' : *{authorNickname}">김개발</span>
                                </div>
                            </div>
                            
                            <div class="text-gray-700 mb-6" th:text="*{content}"></div>
                            
                            <!-- 대댓글 섹션 -->
                            <div class="mt-4 space-y-4 pl-8 border-l-2 border-gray-200">
                                <div class="bg-gray-50 rounded p-3" th:each="comment : ${answer.comments}"
                                     th:object="${comment}">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center">
                                            <div class="w-6 h-6 rounded-full bg-gray-500"></div>
                                            <span class="font-medium ml-2"
                                                  th:text="*{anonymous} ? '익명' : *{authorNickname}">대댓쓴이</span>
                                            <span class="ml-2 text-sm text-gray-500"
                                                  th:text="*{createdAt}">2024-01-02 14:30</span>
                                        </div>
                                        <!-- 대댓글 수정/삭제 버튼 추가 -->
                                        <div class="flex gap-2" th:if="${user.id == comment.authorId}">
                                            <a th:href="@{/comments/{id}/edit(id=*{commentId})}"
                                               class="px-2 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200 transition-colors">
                                                수정
                                            </a>
                                            <a th:href="@{/comments/{id}/delete(id=*{commentId})}"
                                               class="px-2 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                                                삭제
                                            </a>
                                        </div>
                                    </div>
                                    <p class="text-gray-700" th:text="*{content}">대댓글 내용</p>
                                </div>
                            </div>
                            
                            <!-- 대댓글 작성 폼 -->
                            <div class="mt-4">
                                <button onclick="toggleCommentForm(this)"
                                        th:attr="data-answer-id=*{answerId}"
                                        class="text-blue-500 hover:text-blue-700 text-sm font-medium focus:outline-none">
                                    댓글 달기
                                </button>
                                
                                <div th:id="'commentForm-' + *{answerId}" class="hidden mt-3">
                                    <form th:action="@{/questions/{questionId}/answers/{answerId}/comment(questionId=${question.questionId},answerId=*{answerId})}"
                                          method="POST">
                                        <textarea name="content"
                                                  class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                                  rows="2"
                                                  placeholder="댓글을 입력하세요..."></textarea>
                                        <div class="flex items-center justify-between mt-2">
                                            <div class="flex items-center space-x-2">
                                                <input type="checkbox"
                                                       th:id="'anonymous-' + *{answerId}"
                                                       th:field="${commentCreateForm.anonymous}"
                                                       class="rounded border-gray-300 text-blue-500 focus:ring-blue-500">
                                                <label th:for="'anonymous-' + *{answerId}"
                                                       class="text-sm text-gray-600">
                                                    익명으로 작성하기
                                                </label>
                                            </div>
                                            <button type="submit"
                                                    class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 focus:outline-none text-sm">
                                                댓글 등록
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </main>
        
        <!-- JavaScript -->
        <script>
            // 별점 평가 함수
            async function rateAnswer(answerId, rating) {
                try {
                    const response = await fetch(`/api/answers/${answerId}/rate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({rating: rating})
                    });

                    if (!response.ok) {
                        throw new Error('평가 제출에 실패했습니다.');
                    }

                    const result = await response.json();
                    updateStarRating(answerId, rating);

                    const ratingContainer = document.querySelector(`[data-answer-id="${answerId}"]`)
                        .closest('.flex')
                        .querySelector('span');
                    ratingContainer.textContent = `${result.averageScore.toFixed(1)} (${result.voterCount}명)`;

                } catch (error) {
                    console.error('Error:', error);
                    alert('평가 제출 중 오류가 발생했습니다.');
                }
            }

            // 별점 UI 업데이트 함수
            function updateStarRating(answerId, selectedRating) {
                const stars = document.querySelector(`[data-answer-id="${answerId}"]`)
                    .querySelectorAll('svg');

                stars.forEach((star, index) => {
                    if (index < selectedRating) {
                        star.classList.remove('text-gray-200');
                        star.classList.add('text-yellow-400');
                    } else {
                        star.classList.remove('text-yellow-400');
                        star.classList.add('text-gray-200');
                    }
                });
            }

            // 개선된 토글 함수들
            function toggleCommentForm(button) {
                const answerId = button.getAttribute('data-answer-id');
                const formId = `commentForm-${answerId}`;
                const form = document.getElementById(formId);

                // 다른 모든 폼 닫기
                document.querySelectorAll('[id^="commentForm-"]').forEach(otherForm => {
                    if (otherForm.id !== formId) {
                        otherForm.classList.add('hidden');
                    }
                });

                // 현재 폼 토글
                form.classList.toggle('hidden');
            }

            function toggleAnswerForm() {
                const form = document.getElementById('answer-form');
                form.classList.toggle('hidden');
            }
        </script>
    </body>
</html>