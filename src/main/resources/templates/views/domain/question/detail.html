<!DOCTYPE html>
<html th:replace="~{layout/user-layout::user-template(${user},~{::title},~{::body})}">
    <head>
        <title>면접 질문 상세글</title>
    </head>
    <body>
        <main class="max-w-5xl mx-auto mt-8 px-4 pb-12">
            <!-- 질문글 상세 및 답글 섹션 -->
            <th:block
                    th:replace="~{fragments/posting/post-layout::content-template(user=${user}, type='questions', post=${questionDetails.question}, content=~{::content}, answerCreateForm=${answerCreateForm})}">
                <content th:text="${questionDetails.question.content}"></content>
            </th:block>
            
            <!-- 답변 목록 -->
            <section class="space-y-6">
                <div th:each="answer : ${questionDetails.answers}"
                     class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div th:object="${answer}">
                        <!-- 답변 헤더 -->
                        <div class="p-6 flex items-start justify-between border-b border-gray-100">
                            <!--사용자 정보 -->
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center">
                                    <i data-lucide="user" class="w-6 h-6 text-gray-500"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-gray-900"
                                         th:text="*{anonymous} ? '익명' : *{authorNickname}">답변자
                                    </div>
                                    <div class="text-sm text-gray-500">
                                            <span class="timeago" th:data-date="*{createdAt}"
                                                  th:text="${#temporals.format(createdAt, 'yyyy/MM/dd hh:mm')}">
                                            </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 평점 & 삭제 버튼 -->
                            <div class="flex items-center gap-4">
                                <div class="flex items-center" th:attr="data-answer-id=*{id}">
                                    <div class="flex gap-1">
                                        <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                            <button type="button"
                                                    th:onclick="|rateAnswer(*{id}, ${i})|"
                                                    class="focus:outline-none transition-transform hover:scale-110"
                                                    th:attr="data-rating=${i}">
                                                <!--                                                <i data-lucide="star"-->
                                                <!--                                                   th:class="|w-5 h-5 ${i <= answer.averageScore ? 'text-yellow-400 fill-yellow-400' : 'text-gray-300'} transition-colors|">-->
                                                <!--                                                </i>-->
                                            </button>
                                        </th:block>
                                    </div>
                                    <!--                                    <span class="ml-2 text-sm text-gray-600"-->
                                    <!--                                          th:text="|*{averageScore} (*{voterCount}명)|"></span>-->
                                </div>
                                <div th:if="${user.id == answer.authorId}">
                                    <button th:onclick="'deleteAnswer(' + *{id} + ')'"
                                            class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors">
                                        <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        삭제
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 답변 내용 -->
                        <div class="p-6">
                            <div class="prose max-w-none" th:text="*{content}">답변 내용</div>
                        </div>
                        
                        <!-- 댓글 섹션 -->
                        <div class="border-t border-gray-100">
                            <div class="p-6">
                                <div class="space-y-4">
                                    <!-- 댓글 목록 -->
                                    <div th:each="comment : *{comments}" class="flex items-start gap-3 pb-4">
                                        <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center flex-shrink-0">
                                            <i data-lucide="user" class="w-5 h-5 text-gray-500"></i>
                                        </div>
                                        <div class="flex-1" th:object="${comment}">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center gap-2">
                                                        <span class="font-medium text-gray-900"
                                                              th:text="*{anonymous} ? '익명' : *{authorNickname}">댓글작성자</span>
                                                    <span class="text-sm text-gray-500 timeago"
                                                          th:data-date="*{createdAt}"
                                                          th:text="${#temporals.format(createdAt, 'yyyy/MM/dd hh:mm')}">
                                                        </span>
                                                </div>
                                                <button th:if="${user.id == comment.authorId}"
                                                        th:onclick="'deleteComment(' + *{id} + ')'"
                                                        class="text-gray-400 hover:text-red-600">
                                                    <i data-lucide="x" class="w-4 h-4"></i>
                                                </button>
                                            </div>
                                            <p class="text-gray-700 mt-1" th:text="*{content}">댓글 내용</p>
                                        </div>
                                    </div>
                                    
                                    <!-- 댓글 작성 폼 -->
                                    <div class="mt-4">
                                        <button onclick="toggleCommentForm(this)"
                                                th:attr="data-answer-id=*{id}"
                                                class="text-blue-600 hover:text-blue-700 text-sm font-medium focus:outline-none">
                                            댓글 달기
                                        </button>
                                        
                                        <div th:id="'commentForm-' + *{id}" class="hidden mt-3">
                                            <!-- 요기 수정-->
                                            <form th:action="@{/comments(answerId=*{id})}"
                                                  method="POST"
                                                  class="flex flex-col gap-3">
                                                <textarea name="content"
                                                          class="w-full p-3 text-sm border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                                          rows="2"
                                                          placeholder="댓글을 입력하세요..."></textarea>
                                                <div class="flex items-center justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <input type="checkbox"
                                                               th:id="'anonymous-' + *{id}"
                                                               th:field="${commentCreateForm.anonymous}"
                                                               class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                                        <label th:for="'anonymous-' + *{id}"
                                                               class="text-sm text-gray-600">
                                                            익명으로 작성하기
                                                        </label>
                                                    </div>
                                                    <button type="submit"
                                                            class="px-4 py-2 bg-blue-600 text-white text-sm rounded-lg hover:bg-blue-700 transition-colors">
                                                        댓글 등록
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
        
        <script>
            // Lucide 아이콘 초기화
            lucide.createIcons();

            // 별점 평가 함수
            async function rateAnswer(answerId, rating) {
                try {
                    const response = await fetch(`/api/answers/${answerId}/rate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(rating)
                    });

                    if (response.status === 409) {
                        alert('이미 평가한 답변입니다. 답변당 한 번만 평가할 수 있습니다.');
                        return;
                    }

                    if (!response.ok) {
                        throw new Error('평가 제출에 실패했습니다.');
                    }

                    const result = await response.json();
                    updateStarRating(answerId, rating);

                    const ratingContainer = document.querySelector(`[data-answer-id="${answerId}"]`)
                        .querySelector('span');
                    ratingContainer.textContent = `${result.averageScore.toFixed(1)} (${result.voterCount}명)`;

                } catch (error) {
                    console.error('Error:', error);
                    alert('평가 제출 중 오류가 발생했습니다.');
                }
            }

            // 별점 UI 업데이트 함수
            function updateStarRating(answerId, selectedRating) {
                const stars = document.querySelector(`[data-answer-id="${answerId}"]`)
                    .querySelectorAll('i[data-lucide="star"]');

                stars.forEach((star, index) => {
                    if (index < selectedRating) {
                        star.classList.remove('text-gray-300');
                        star.classList.add('text-yellow-400', 'fill-yellow-400');
                    } else {
                        star.classList.remove('text-yellow-400', 'fill-yellow-400');
                        star.classList.add('text-gray-300');
                    }
                });
            }

            // 댓글 폼 토글 함수
            function toggleCommentForm(button) {
                const answerId = button.getAttribute('data-answer-id');
                const formId = `commentForm-${answerId}`;
                const form = document.getElementById(formId);

                // 다른 모든 폼 닫기
                document.querySelectorAll('[id^="commentForm-"]').forEach(otherForm => {
                    if (otherForm.id !== formId) {
                        otherForm.classList.add('hidden');
                    }
                });

                // 현재 폼 토글
                form.classList.toggle('hidden');
            }

            async function deleteAnswer(answerId) {
                if (confirm('정말 삭제하시겠습니까?')) {
                    try {
                        const response = await fetch(`/api/answers/${answerId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        if (!response.ok) {
                            throw new Error('삭제에 실패했습니다.');
                        }

                        window.location.reload();
                    } catch (error) {
                        console.error('Error:', error);
                        alert('삭제 중 오류가 발생했습니다.');
                    }
                }
            }

            async function deleteComment(commentId) {
                if (confirm('정말 삭제하시겠습니까?')) {
                    try {
                        const response = await fetch(`/api/comments/${commentId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json',
                            }
                        });

                        if (!response.ok) {
                            throw new Error('삭제에 실패했습니다.');
                        }

                        window.location.reload();
                    } catch (error) {
                        console.error('Error:', error);
                        alert('삭제 중 오류가 발생했습니다.');
                    }
                }
            }
        </script>
    </body>
</html>